name: Build and Package DockerImageBuilder.Alpine
on:
  push:
    branches: [main,master]
    paths:  [ 'src/DockerImageBuilder.Alpine/**', 'Directory.Packages.props' ]
  pull_request:
    branches: [main,master]
    paths:  [ 'src/DockerImageBuilder.Alpine/**' ]
  workflow_dispatch:
    inputs:
      configuration:
        type: choice
        description: The build configuration to use in the deploy stage.
        required: true
        default: Release
        options:
          - Debug
          - Release

env:
  TIMEZONE: 'Europe/Rome'
  CONFIGURATION: 'Release'
  PROJECT_PATH: src/DockerImageBuilder.Alpine
  PROJECT_NAME: DockerImageBuilder.Alpine.csproj
  PACKAGE_NAME: Maurosoft.DockerImageBuilder.Alpine
  BUILD_ARTIFACT: Maurosoft.DockerImageBuilder.Alpine

jobs:
  build:
    name: üõ†Ô∏è Build
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.nbgv.outputs.SemVer2 }}
    steps:
      - name: Checkout
        uses: maurosoft1973/gha-git-checkout@v1

      - name: Install .NET
        uses: maurosoft1973/gha-dotnet-install@v1
        with:
          includeEndOfFileVersion: true

      - name: Nerdbank.GitVersioning 
        uses: dotnet/nbgv@v0.4
        id: nbgv
        with:
          path: ${{ env.PROJECT_PATH }}

      - name: Restore Dependencies
        uses: maurosoft1973/gha-dotnet-restore@v1

      - name: Build for ${{ env.PROJECT_NAME }} (${{ env.CONFIGURATION }})
        uses: maurosoft1973/gha-dotnet-build@v1
        with:
          projects: ${{ env.PROJECT_PATH }}/${{ env.PROJECT_NAME }}
          configuration: ${{ env.CONFIGURATION }}
          uploadBuildArtifactName: ${{ env.BUILD_ARTIFACT }}

  test:
    name: üß™ Test
    needs: [build]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: maurosoft1973/gha-git-checkout@v1

      - name: Install .NET
        uses: maurosoft1973/gha-dotnet-install@v1
        with:
          includeEndOfFileVersion: true

      - name: Install .NET Tool - Report Generator
        uses: maurosoft1973/gha-dotnet-tool-install-reportgenerator@v1

      - name: Set Timezone ${{ env.TIMEZONE }}
        uses: szenius/set-timezone@v2.0
        with:
          timezoneLinux: ${{ env.TIMEZONE }}

      - name: Run Test
        uses: maurosoft1973/gha-dotnet-test@v1
        with:
          level: minimal

  pack:
    name: üì¶ Pack
    runs-on: ubuntu-latest
    needs: [build,test]
    steps:
      - name: Install .NET
        uses: maurosoft1973/gha-dotnet-install@v1
        with:
          includeEndOfFileVersion: true

      - name: Pack for ${{ env.PACKAGE_NAME }} - ${{ env.CONFIGURATION }}
        uses: maurosoft1973/gha-dotnet-pack@v1
        with:
          downloadArtifactName: ${{ env.BUILD_ARTIFACT }}
          level: 'normal'
          packageName: ${{ env.PACKAGE_NAME }}
          packageVersion: ${{ needs.build.outputs.version }}
          projects: ${{ env.PROJECT_PATH }}/${{ env.PROJECT_NAME }}
          uploadPackedArtifact: true

  deploy:
    name: üöÄ Deploy v${{ needs.build.outputs.version }}
    runs-on: ubuntu-latest
    needs: [build,pack,test]
    environment: Production
    steps:
      - name: Download ${{ env.PACKAGE_NAME }}.nupkg
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.PACKAGE_NAME }}.${{ needs.build.outputs.version }}.nupkg

      - name: Install .NET
        uses: maurosoft1973/gha-dotnet-install@v1
        with:
          includeEndOfFileVersion: true

      - name: Publish package to maurosoft
        run: dotnet nuget push '${{ github.workspace }}/*.nupkg' --api-key "${{ secrets.NUGET_MAUROSOFT_API_KEY }}" --source https://nuget.maurosoft.com/v3/index.json --skip-duplicate

      #- name: Publish package to nuget
      #  run: dotnet nuget push '${{ github.workspace }}/*.nupkg' --api-key "${{ secrets.NUGET_API_KEY }}" --source https://api.nuget.org/v3/index.json --skip-duplicate
