name: Build Alpine Docker Images

on:
  # Esecuzione schedulata: ogni giorno alle 03:00 UTC
  schedule:
    - cron: '0 3 * * *'

  # Push su main (solo se cambia qualcosa nei sorgenti o nel workflow)
  push:
    branches: [main, master]
    paths:
      - 'src/**'
      - '.github/workflows/build.yaml'

  # Esecuzione manuale con parametri configurabili
  workflow_dispatch:
    inputs:
      architectures:
        type: string
        description: 'Architetture da buildare (comma-separated)'
        required: false
        default: 'x86_64,aarch64'
      do_push:
        type: choice
        description: 'Push immagini su registry'
        required: false
        default: 'true'
        options:
          - 'true'
          - 'false'
      enable_health_checks:
        type: choice
        description: 'Esegui health checks post-build'
        required: false
        default: 'true'
        options:
          - 'true'
          - 'false'

env:
  TIMEZONE: 'Europe/Rome'
  DOTNET_VERSION: '9.0.x'
  CONSOLE_PROJECT: src/DockerAlpine/DockerAlpine.csproj

jobs:
  build-and-run:
    name: üê≥ Build & Push Alpine Images
    runs-on: ubuntu-latest

    # Permessi necessari per push git del manifest
    permissions:
      contents: write
      packages: write

    steps:
      # ==================== SETUP ====================

      - name: üì• Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ‚è∞ Set Timezone
        uses: szenius/set-timezone@v2.0
        with:
          timezoneLinux: ${{ env.TIMEZONE }}

      - name: üîß Install .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: üêã set up docker buildx
        uses: docker/setup-buildx-action@v3

      - name: üêã set up qemu (multi-architecture)
        uses: docker/setup-qemu-action@v3

      # ==================== BUILD & RUN ====================
      - name: üõ†Ô∏è Build console application
        run: dotnet build "${{ env.CONSOLE_PROJECT }}" --configuration Release --output "${{ github.workspace }}/artifacts"

      - name: üöÄ Run Alpine Image Builder
        env:
          ARCHITECTURES: ${{ github.event.inputs.architectures || 'x86_64,aarch64' }}
          IMAGE_NAME: ${{ vars.IMAGE_NAME || 'alpine' }}
          DO_PUSH: ${{ github.event.inputs.do_push || 'true' }}
          ENABLE_HEALTH_CHECKS: ${{ github.event.inputs.enable_health_checks || 'true' }}
          ENABLE_VULN_SCAN: 'false'
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          LIMIT: 1
        run: |
            set -euxo pipefail
            cd "${{ github.workspace }}/artifacts"
            dotnet DockerAlpine.dll
