name: Build Alpine Docker Images

on:
  # Esecuzione schedulata: ogni giorno alle 03:00 UTC
  schedule:
    - cron: '0 3 * * *'

  # Esecuzione manuale con parametri configurabili
  workflow_dispatch:
    inputs:
      architectures:
        type: string
        description: 'Architetture da buildare (comma-separated)'
        required: false
        default: 'x86_64,aarch64'
      do_push:
        type: boolean
        description: 'Push immagini su registry'
        required: false
        default: true
      enable_health_checks:
        type: boolean
        description: 'Esegui health checks post-build'
        required: false
        default: true

env:
  TIMEZONE: 'Europe/Rome'
  DOTNET_VERSION: '9.0.x'
  CONSOLE_PROJECT: src/DockerAlpine/DockerAlpine.csproj
  # Configurazione immagini
  ARCHITECTURES: ${{ github.event.inputs.architectures || 'x86_64,aarch64' }}
  IMAGE_NAME: ${{ vars.IMAGE_NAME || 'alpinenew' }}
  DO_PUSH: ${{ github.event.inputs.do_push || 'true' }}
  ENABLE_HEALTH_CHECKS: ${{ github.event.inputs.enable_health_checks || 'true' }}
  ENABLE_VULN_SCAN: 'false'

jobs:
  build-and-run:
    name: ðŸ³ Build & Push Alpine Images
    runs-on: ubuntu-latest

    # Permessi necessari per push git del manifest
    permissions:
      contents: write

    steps:
      # ==================== SETUP ====================

      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: â° Set Timezone ${{ env.TIMEZONE }}
        uses: szenius/set-timezone@v2.0
        with:
          timezoneLinux: ${{ env.TIMEZONE }}

      - name: ðŸ”§ Install .NET SDK ${{ env.DOTNET_VERSION }}
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: ðŸ‹ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ‹ Set up QEMU (multi-architecture)
        uses: docker/setup-qemu-action@v3

      # ==================== DOCKER LOGIN ====================

      - name: ðŸ”‘ Login to Docker Hub
        if: env.DO_PUSH == 'true' && secrets.DOCKER_USERNAME != ''
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: ðŸ”‘ Login to GitHub Container Registry
        if: env.DO_PUSH == 'true' && secrets.GHCR_TOKEN != ''
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_TOKEN }}

      # ==================== BUILD & RUN ====================

      - name: ðŸ“¦ Restore dependencies
        run: dotnet restore ${{ env.CONSOLE_PROJECT }}

      - name: ðŸ› ï¸ Build console application
        run: dotnet build ${{ env.CONSOLE_PROJECT }} --configuration Release --no-restore

      - name: ðŸš€ Run Alpine Image Builder
        env:
          GITHUB_WORKSPACE: ${{ github.workspace }}
          ARCHITECTURES: ${{ env.ARCHITECTURES }}
          IMAGE_NAME: ${{ env.IMAGE_NAME }}
          DO_PUSH: ${{ env.DO_PUSH }}
          ENABLE_HEALTH_CHECKS: ${{ env.ENABLE_HEALTH_CHECKS }}
          ENABLE_VULN_SCAN: ${{ env.ENABLE_VULN_SCAN }}
          # Credenziali registry (dal secrets)
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_TOKEN: ${{ secrets.DOCKER_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: dotnet run --project ${{ env.CONSOLE_PROJECT }} --configuration Release --no-build

      # ==================== COMMIT MANIFEST ====================

      - name: ðŸ“ Commit and push manifest.json
        if: always()
        run: |
          cd ${{ github.workspace }}
          if git diff --quiet -- 'src/DockerAlpine/Alpine/manifest.json' 2>/dev/null && \
             git diff --cached --quiet -- 'src/DockerAlpine/Alpine/manifest.json' 2>/dev/null && \
             [ -z "$(git ls-files --others --exclude-standard -- 'src/DockerAlpine/Alpine/manifest.json')" ]; then
            echo "No changes in manifest.json, skipping commit"
          else
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add src/DockerAlpine/Alpine/manifest.json
            git commit -m "chore: update manifest.json [skip ci]"
            git push
            echo "Manifest committed and pushed"
          fi
