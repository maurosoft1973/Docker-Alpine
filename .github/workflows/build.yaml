name: Build Alpine Docker Images

on:
  # Esecuzione schedulata: ogni giorno alle 03:00 UTC
  schedule:
    - cron: '0 3 * * *'

  # Push su main (solo se cambia qualcosa nei sorgenti o nel workflow)
  push:
    branches: [main, master]
    paths:
      - 'src/**'
      - '.github/workflows/build.yaml'

  # Esecuzione manuale con parametri configurabili
  workflow_dispatch:
    inputs:
      architectures:
        type: string
        description: 'Architetture da buildare (comma-separated)'
        required: false
        default: 'x86_64,aarch64'
      do_push:
        type: choice
        description: 'Push immagini su registry'
        required: false
        default: 'true'
        options:
          - 'true'
          - 'false'
      enable_health_checks:
        type: choice
        description: 'Esegui health checks post-build'
        required: false
        default: 'true'
        options:
          - 'true'
          - 'false'

env:
  TIMEZONE: 'Europe/Rome'
  DOTNET_VERSION: '9.0.x'
  CONSOLE_PROJECT: src/DockerAlpine/DockerAlpine.csproj

jobs:
  build-and-run:
    name: ðŸ³ Build & Push Alpine Images
    runs-on: ubuntu-latest

    # Permessi necessari per push git del manifest
    permissions:
      contents: write
      packages: write

    steps:
      # ==================== SETUP ====================

      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: â° Set Timezone
        uses: szenius/set-timezone@v2.0
        with:
          timezoneLinux: ${{ env.TIMEZONE }}

      - name: ðŸ”§ Install .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: ðŸ‹ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ‹ Set up QEMU (multi-architecture)
        uses: docker/setup-qemu-action@v3

      # ==================== DOCKER LOGIN ====================

      - name: ðŸ”‘ Login to Docker Hub
        if: env.DOCKER_USERNAME != ''
        uses: docker/login-action@v3
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: ðŸ”‘ Login to GitHub Container Registry
        if: env.GHCR_TOKEN != ''
        uses: docker/login-action@v3
        env:
          GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_TOKEN }}

      # ==================== BUILD & RUN ====================

      - name: ðŸ“¦ Restore dependencies
        run: dotnet restore ${{ env.CONSOLE_PROJECT }}

      - name: ðŸ› ï¸ Build console application
        run: dotnet build ${{ env.CONSOLE_PROJECT }} --configuration Release --output ${{ github.workspace }}/artifacts

      - name: ðŸ” Debug - Verify project structure
        run: |
          echo "=== Workspace: ${{ github.workspace }} ==="
          echo "=== GITHUB_WORKSPACE (app): ${{ github.workspace }}/artifacts ==="
          echo "=== Project directory contents ==="
          ls -la ${{ github.workspace }}/artifacts/Alpine/ || echo "artifacts/Alpine/ DIR NOT FOUND!"
          echo "=== Check appsettings.json ==="
          ls -la ${{ github.workspace }}/artifacts/Alpine/appsettings.json || echo "appsettings.json NOT FOUND!"
          echo "=== Check .env ==="
          ls -la ${{ github.workspace }}/artifacts/Alpine/.env || echo ".env NOT FOUND!"
          echo "=== Check Alpine Docker directory ==="
          ls -la ${{ github.workspace }}/artifacts/Alpine/Alpine/ 2>/dev/null || echo "artifacts/Alpine/ dir not found"
          echo "=== Check Dockerfile ==="
          ls -la ${{ github.workspace }}/artifacts/Alpine/Docker/Dockerfile 2>/dev/null || echo "Dockerfile not found"

      - name: ðŸš€ Run Alpine Image Builder
        env:
          GITHUB_WORKSPACE: ${{ github.workspace }}/artifacts
          ARCHITECTURES: ${{ github.event.inputs.architectures || 'x86_64,aarch64' }}
          IMAGE_NAME: ${{ vars.IMAGE_NAME || 'alpine' }}
          DO_PUSH: ${{ github.event.inputs.do_push || 'true' }}
          ENABLE_HEALTH_CHECKS: ${{ github.event.inputs.enable_health_checks || 'true' }}
          ENABLE_VULN_SCAN: 'false'
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_TOKEN: ${{ secrets.DOCKER_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: cd ${{ github.workspace }}/artifacts && dotnet DockerAlpine.dll

      - name: ðŸ” Debug - Check exit and logs
        if: always()
        run: |
          echo "=== Checking for log files ==="
          find ${{ github.workspace }}/artifacts/Alpine -name "*.log" -type f 2>/dev/null || echo "No log files found"
          echo "=== Checking Alpine dir after run ==="
          ls -laR ${{ github.workspace }}/artifacts/Alpine/ 2>/dev/null || echo "artifacts/Alpine/ not found"
          echo "=== Checking manifest.json ==="
          cat ${{ github.workspace }}/artifacts/Alpine/manifest.json 2>/dev/null || echo "manifest.json not found"

      # ==================== COMMIT MANIFEST ====================

      - name: ðŸ“ Commit and push manifest.json
        if: always()
        run: |
          MANIFEST_PATH="src/DockerAlpine/Alpine/manifest.json"

          if git diff --quiet -- "$MANIFEST_PATH" 2>/dev/null && \
             git diff --cached --quiet -- "$MANIFEST_PATH" 2>/dev/null && \
             [ -z "$(git ls-files --others --exclude-standard -- "$MANIFEST_PATH")" ]; then
            echo "::notice::No changes in manifest.json, skipping commit"
          else
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add "$MANIFEST_PATH"
            git commit -m "chore: update manifest.json [skip ci]"
            git push
            echo "::notice::Manifest committed and pushed successfully"
          fi
